name: Docker Build, Push & Deploy by Service (with Debug & .env for Tests and Deploy)

on:
  push:
    branches: [main, test]
    paths:
      - 'add-like/**'
      - 'get-likes/**'
      - 'remove-like/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
    paths:
      - 'add-like/**'
      - 'get-likes/**'
      - 'remove-like/**'
      - '.github/workflows/**'

env:
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  DB_PORT: ${{ secrets.DB_PORT }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  PET_DB_NAME: ${{ secrets.PET_DB_NAME }}
  POST_DB_NAME: ${{ secrets.POST_DB_NAME }}
  REACTIONS_DB_NAME: ${{ secrets.REACTIONS_DB_NAME }}
  WEBHOOK_NOTIFICATIONS_URL: ${{ secrets.WEBHOOK_NOTIFICATIONS_URL }}
  REDIS_HOST: ${{ secrets.REDIS_HOST }}
  REDIS_PORT: ${{ secrets.REDIS_PORT }}
  EC2_REACTIONS_DOMAIN_TEST: ${{ secrets.EC2_REACTIONS_DOMAIN_TEST }}
  EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      addlike: ${{ steps.filter.outputs.addlike }}
      getlikes: ${{ steps.filter.outputs.getlikes }}
      removelike: ${{ steps.filter.outputs.removelike }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            addlike:
              - 'add-like/**'
            getlikes:
              - 'get-likes/**'
            removelike:
              - 'remove-like/**'

  add_like_service:
    needs: changes
    if: needs.changes.outputs.addlike == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Instalar y preparar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generar .env para tests
        working-directory: ./add-like
        run: |
          cat <<EOF > .env
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=${{ secrets.DB_PORT }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          PET_DB_NAME=${{ secrets.PET_DB_NAME }}
          POST_DB_NAME=${{ secrets.POST_DB_NAME }}
          REACTIONS_DB_NAME=${{ secrets.REACTIONS_DB_NAME }}
          WEBHOOK_NOTIFICATIONS_URL=${{ secrets.WEBHOOK_NOTIFICATIONS_URL }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          EOF

      - name: Instalar dependencias y ejecutar tests
        working-directory: ./add-like
        run: |
          pip install -r requirements.txt
          pytest

      - name: Debug - Listar archivos antes del build Docker
        working-directory: ./add-like
        run: ls -l

      - name: Debug - Mostrar ruta actual
        working-directory: ./add-like
        run: pwd

      - name: Debug - Mostrar contenido de Dockerfile
        working-directory: ./add-like
        run: cat Dockerfile || echo "NO DOCKERFILE FOUND"

      - name: Construir imagen Docker (buildx)
        working-directory: ./add-like
        run: |
          docker buildx build --load -t ${{ secrets.DOCKERHUB_USERNAME }}/add-like:${{ github.sha }} .

      - name: Login a DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Subir imagen a DockerHub
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/add-like:${{ github.sha }}

      - name: Desplegar en EC2 por SSH (con .env)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_REACTIONS_DOMAIN_TEST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cat <<EOF > /home/ubuntu/add-like.env
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_PORT=${{ secrets.DB_PORT }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            PET_DB_NAME=${{ secrets.PET_DB_NAME }}
            POST_DB_NAME=${{ secrets.POST_DB_NAME }}
            REACTIONS_DB_NAME=${{ secrets.REACTIONS_DB_NAME }}
            WEBHOOK_NOTIFICATIONS_URL=${{ secrets.WEBHOOK_NOTIFICATIONS_URL }}
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            EOF

            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/add-like:${{ github.sha }}
            docker stop add-like || true && docker rm add-like || true
            docker run -d --name add-like \
              --env-file /home/ubuntu/add-like.env \
              -p 6001:6001 \
              ${{ secrets.DOCKERHUB_USERNAME }}/add-like:${{ github.sha }}

  get_likes_service:
    needs: changes
    if: needs.changes.outputs.getlikes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Instalar y preparar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generar .env para tests
        working-directory: ./get-likes
        run: |
          cat <<EOF > .env
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=${{ secrets.DB_PORT }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          PET_DB_NAME=${{ secrets.PET_DB_NAME }}
          POST_DB_NAME=${{ secrets.POST_DB_NAME }}
          REACTIONS_DB_NAME=${{ secrets.REACTIONS_DB_NAME }}
          WEBHOOK_NOTIFICATIONS_URL=${{ secrets.WEBHOOK_NOTIFICATIONS_URL }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          EOF

      - name: Instalar dependencias y ejecutar tests
        working-directory: ./get-likes
        run: |
          pip install -r requirements.txt
          pytest

      - name: Debug - Listar archivos antes del build Docker
        working-directory: ./get-likes
        run: ls -l

      - name: Debug - Mostrar ruta actual
        working-directory: ./get-likes
        run: pwd

      - name: Debug - Mostrar contenido de Dockerfile
        working-directory: ./get-likes
        run: cat Dockerfile || echo "NO DOCKERFILE FOUND"

      - name: Construir imagen Docker (buildx)
        working-directory: ./get-likes
        run: |
          docker buildx build --load -t ${{ secrets.DOCKERHUB_USERNAME }}/get-likes:${{ github.sha }} .

      - name: Login a DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Subir imagen a DockerHub
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/get-likes:${{ github.sha }}

      - name: Desplegar en EC2 por SSH (con .env)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_REACTIONS_DOMAIN_TEST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cat <<EOF > /home/ubuntu/get-likes.env
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_PORT=${{ secrets.DB_PORT }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            PET_DB_NAME=${{ secrets.PET_DB_NAME }}
            POST_DB_NAME=${{ secrets.POST_DB_NAME }}
            REACTIONS_DB_NAME=${{ secrets.REACTIONS_DB_NAME }}
            WEBHOOK_NOTIFICATIONS_URL=${{ secrets.WEBHOOK_NOTIFICATIONS_URL }}
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            EOF

            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/get-likes:${{ github.sha }}
            docker stop get-likes || true && docker rm get-likes || true
            docker run -d --name get-likes \
              --env-file /home/ubuntu/get-likes.env \
              -p 6003:6003 \
              ${{ secrets.DOCKERHUB_USERNAME }}/get-likes:${{ github.sha }}

  remove_like_service:
    needs: changes
    if: needs.changes.outputs.removelike == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Instalar y preparar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generar .env para tests
        working-directory: ./remove-like
        run: |
          cat <<EOF > .env
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=${{ secrets.DB_PORT }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          PET_DB_NAME=${{ secrets.PET_DB_NAME }}
          POST_DB_NAME=${{ secrets.POST_DB_NAME }}
          REACTIONS_DB_NAME=${{ secrets.REACTIONS_DB_NAME }}
          WEBHOOK_NOTIFICATIONS_URL=${{ secrets.WEBHOOK_NOTIFICATIONS_URL }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          EOF

      - name: Instalar dependencias y ejecutar tests
        working-directory: ./remove-like
        run: |
          pip install -r requirements.txt
          pytest

      - name: Debug - Listar archivos antes del build Docker
        working-directory: ./remove-like
        run: ls -l

      - name: Debug - Mostrar ruta actual
        working-directory: ./remove-like
        run: pwd

      - name: Debug - Mostrar contenido de Dockerfile
        working-directory: ./remove-like
        run: cat Dockerfile || echo "NO DOCKERFILE FOUND"

      - name: Construir imagen Docker (buildx)
        working-directory: ./remove-like
        run: |
          docker buildx build --load -t ${{ secrets.DOCKERHUB_USERNAME }}/remove-like:${{ github.sha }} .

      - name: Login a DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Subir imagen a DockerHub
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/remove-like:${{ github.sha }}

      - name: Desplegar en EC2 por SSH (con .env)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_REACTIONS_DOMAIN_TEST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cat <<EOF > /home/ubuntu/remove-like.env
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_PORT=${{ secrets.DB_PORT }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            PET_DB_NAME=${{ secrets.PET_DB_NAME }}
            POST_DB_NAME=${{ secrets.POST_DB_NAME }}
            REACTIONS_DB_NAME=${{ secrets.REACTIONS_DB_NAME }}
            WEBHOOK_NOTIFICATIONS_URL=${{ secrets.WEBHOOK_NOTIFICATIONS_URL }}
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            EOF

            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/remove-like:${{ github.sha }}
            docker stop remove-like || true && docker rm remove-like || true
            docker run -d --name remove-like \
              --env-file /home/ubuntu/remove-like.env \
              -p 6002:6002 \
              ${{ secrets.DOCKERHUB_USERNAME }}/remove-like:${{ github.sha }}